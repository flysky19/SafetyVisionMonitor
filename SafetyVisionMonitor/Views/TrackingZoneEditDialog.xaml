<Window x:Class="SafetyVisionMonitor.Views.TrackingZoneEditDialog"
                             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                             xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
                             mc:Ignorable="d"
                             Title="트래킹 구역 편집" Height="600" Width="800"
                             WindowStartupLocation="CenterOwner"
                             Style="{StaticResource CustomWindowStyle}">
    
    <Grid Background="#1A1A1A">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 헤더 -->
        <Border Grid.Row="0" Background="#2D2D30" Padding="15">
            <TextBlock Text="트래킹 구역 편집" FontSize="18" FontWeight="Bold" Foreground="White"/>
        </Border>
        
        <!-- 콘텐츠 -->
        <Grid Grid.Row="1" Margin="15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- 속성 패널 -->
            <Border Grid.Column="0" Background="#2D2D30" CornerRadius="5" Padding="15" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock Text="구역 속성" FontSize="16" FontWeight="Bold" Foreground="White" Margin="0,0,0,15"/>
                    
                    <TextBlock Text="구역 ID" Foreground="Gray" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding Zone.Id}" IsReadOnly="True" Margin="0,0,0,10"/>
                    
                    <TextBlock Text="구역명" Foreground="Gray" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding Zone.Name}" Margin="0,0,0,10"/>
                    
                    <TextBlock Text="카메라" Foreground="Gray" Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding AvailableCameras}" 
                              SelectedValue="{Binding Zone.CameraId}"
                              DisplayMemberPath="Name"
                              SelectedValuePath="Id"
                              Margin="0,0,0,15"/>
                    
                    <CheckBox Content="진입 구역" IsChecked="{Binding Zone.IsEntryZone}" 
                              Foreground="White" Margin="0,0,0,10"/>
                    
                    <CheckBox Content="진출 구역" IsChecked="{Binding Zone.IsExitZone}" 
                              Foreground="White" Margin="0,0,0,10"/>
                    
                    <CheckBox Content="카운팅 활성화" IsChecked="{Binding Zone.CountingEnabled}" 
                              Foreground="White" Margin="0,0,0,20"/>
                    
                    <TextBlock Text="좌표 점 목록" FontWeight="Bold" Foreground="White" Margin="0,0,0,10"/>
                    <ListBox ItemsSource="{Binding Zone.PolygonPoints}" 
                             SelectedItem="{Binding SelectedPoint}"
                             Height="150" Background="#1A1A1A">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Foreground="White">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="점: ({0:F0}, {1:F0})">
                                            <Binding Path="X"/>
                                            <Binding Path="Y"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    <Button Content="선택한 점 삭제" Command="{Binding DeletePointCommand}"
                            Margin="0,5,0,0" Background="#E74C3C" Padding="5"/>
                </StackPanel>
            </Border>
            
            <!-- 미리보기 영역 -->
            <Border Grid.Column="1" Background="#2D2D30" CornerRadius="5" Padding="15">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- 미리보기 헤더 -->
                    <Grid Grid.Row="0" Margin="0,0,0,15">
                        <TextBlock Text="구역 미리보기" FontSize="18" FontWeight="Bold" 
                                 Foreground="White"/>
                        <TextBlock HorizontalAlignment="Right" VerticalAlignment="Center"
                                 Foreground="Gray">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="클릭하여 점 추가 ({0}개)">
                                    <Binding Path="Zone.PolygonPoints.Count" FallbackValue="0"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                    </Grid>
                    
                    <!-- 카메라 미리보기 -->
                    <Border Grid.Row="1" Background="#1A1A1A" BorderBrush="#444" BorderThickness="1">
                        <Grid x:Name="VideoContainer">
                            <!-- 1. 카메라 이미지 (베이스 레이어) -->
                            <Image x:Name="CameraImage"
                                 Source="{Binding CameraFrame}" 
                                 Stretch="Uniform"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"/>
                            
                            <!-- 2. 폴리곤 오버레이 캔버스 (탑 레이어) -->
                            <Canvas x:Name="PolygonCanvas"
                                  Background="Transparent"
                                  MouseLeftButtonDown="PreviewArea_MouseLeftButtonDown"/>
                            
                            <!-- 3. 선택된 카메라가 없을 때 -->
                            <TextBlock Text="카메라를 선택하여 구역을 미리보기합니다"
                                     HorizontalAlignment="Center"
                                     VerticalAlignment="Center"
                                     Foreground="Gray"
                                     FontSize="16"
                                     Visibility="{Binding Zone.CameraId, Converter={StaticResource NullToVisibilityConverter}}"/>
                        </Grid>
                    </Border>
                    
                    <!-- 조작 가이드 -->
                    <Border Grid.Row="2" Background="#3D3D40" CornerRadius="5" Padding="10" Margin="0,15,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="조작 방법" FontWeight="Bold" 
                                         Foreground="White" Margin="0,0,0,5"/>
                                <TextBlock Text="• 이미지 클릭: 점 추가" Foreground="Gray" FontSize="12"/>
                                <TextBlock Text="• 최소 3개 점 필요" Foreground="Gray" FontSize="12"/>
                                <TextBlock Text="• 자동으로 폐곡선 생성" Foreground="Gray" FontSize="12"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1" HorizontalAlignment="Right">
                                <TextBlock Text="폴리곤 색상" FontWeight="Bold" 
                                         Foreground="White" Margin="0,0,0,5"/>
                                <StackPanel Orientation="Horizontal">
                                    <Rectangle Width="15" Height="15" Fill="Yellow" Opacity="0.3" 
                                             Stroke="Yellow" StrokeThickness="2" VerticalAlignment="Center"/>
                                    <TextBlock Text="구역 영역" Foreground="Gray" FontSize="12" 
                                             VerticalAlignment="Center" Margin="5,0,0,0"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                    <Ellipse Width="10" Height="10" Fill="Red" Stroke="White" StrokeThickness="2"/>
                                    <TextBlock Text="꼭짓점" Foreground="Gray" FontSize="12" 
                                             VerticalAlignment="Center" Margin="5,0,0,0"/>
                                </StackPanel>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
        
        <!-- 버튼 -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="15">
            <syncfusion:ButtonAdv Label="초기화" Command="{Binding ClearCommand}" 
                                  Width="100" Margin="0,0,10,0"/>
            <syncfusion:ButtonAdv Label="취소" Command="{Binding CancelCommand}" 
                                  Width="100" Margin="0,0,10,0"/>
            <syncfusion:ButtonAdv Label="저장" Command="{Binding SaveCommand}" 
                                  Width="100" SizeMode="Small"/>
        </StackPanel>
    </Grid>
</Window>